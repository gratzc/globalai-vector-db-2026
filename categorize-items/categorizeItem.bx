//Couchbase classes from Java
import com.couchbase.client.java.Bucket;
import com.couchbase.client.java.Cluster;
import com.couchbase.client.java.Collection;
import com.couchbase.client.java.Scope;

//LangChain classes from Java
import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.store.embedding.couchbase.CouchbaseEmbeddingStore;

class categoriezeItems {
	cbUsername = getSystemSetting('cbUsername');
	cbPassword = getSystemSetting('cbPassword');
	cbHostname = getSystemSetting('cbHostname');
	cbBucket = getSystemSetting('cbBucket');
	cbScope = getSystemSetting('cbScope');
	cbCollection = getSystemSetting('cbCollection');
	cbSearchIndex = getSystemSetting('cbSearchIndex');
	embeddingService = new embeddingService();
	function main() {
		try {
			flushData();
			textArray = ['Erasers','Finger Traps','Hall Pass','Compliance Handbook','Manual Pages','The You You Are (Book)','Iceberg Print','Kier Pardons His Betrayers','Kier Invites You to Drink of His Water'];
			createEmbeddings(textArray,true);
			println("");
			println("Catalog items embedded. Querying for top 3 nearest items per query.");
			println("(Higher score = more similar.)");
			println("");
			for (query in ['Coffee Cozies', 'Goodbye, Things', 'Portraiture of Kier Eagan']) {
				println('--- Query: "#query#" ---');
				results = searchItem(query);
				rank = 0;
				for (result in results) {
					rank++;
					scoreStr = round(result.score(), 3);
					println("  #rank#.  #scoreStr#  #result.embedded().text()#");
				}
				println("");
			}
		} catch (Exception e) {
			rethrow;
			println("An error occurred: #e.getMessage()#");
			return;
		}
	}


	function searchItem(item) {
		embeddingStre = getEmbeddingStore();
		r = embeddingService.embed(item);
		oembed = new Embedding(r.data[1].embedding);
		results = embeddingStre.findRelevant(oembed, 3);
		return results;
	}


	function createEmbeddings(textToEmbed,useSavedFile=false) {
		embeddingStre = getEmbeddingStore();

		if(arguments.useSavedFile){
			e = JSONDeserialize(FileRead('savedEmbed.json'));
		} else {
			e = embeddingService.batchEmbed(arguments.textToEmbed);
			FileWrite('savedEmbed.json',JSONSerialize(e));
		}

		index=0

		for (var ar in e) {
			index++;
			oem = new Embedding(ar);
			embeddingStre.add(oem,TextSegment.from(textToEmbed[index]));
		}
		println("Data embedded and saved to Couchbase");
	}


	function getEmbeddingStore() {
		if(!StructKeyExists(this,'embeddingStore')){
			this.embeddingStore = CouchbaseEmbeddingStore.builder()
			.clusterUrl(cbHostname)
			.username(cbUsername)
			.password(cbPassword)
			.bucketName(cbBucket)
			.scopeName(cbScope)
			.collectionName(cbCollection)
			.searchIndexName(cbSearchIndex)
			.dimensions(768)
			.build();
		}

		return this.embeddingStore
	}


	function flushData() {
		embeddingStre = getEmbeddingStore();
		embeddingStre.removeAll();
		println("Old Data Purged");
	}
}